<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การบริหารจัดการน้ำเมืองทองธานี - ภาพรวม</title>
    
    <!-- Google Font KANIT -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- D3.js CDN for charts and CSV fetching -->
    <script src="https://d3js.org/d3.v7.min.js"></script> 
    
    <style>
        /* 1. Dashboard ทั้งหมดให้ใช้ Font "google KANIT" */
        :root {
            font-family: 'Kanit', sans-serif;
        }
        
        /* -------------------------------------------------------- */
        /* CRITICAL: Layout for 100% Viewport Height (Fit to 1 Screen) */
        /* -------------------------------------------------------- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Ensure body takes full screen height */
            overflow: hidden; /* Prevent body scroll, content scrolls internally */
        }

        /* App container takes full screen height and stacks content vertically */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Main content area should fill the remaining space */
        .main-content {
            flex-grow: 1;
            overflow-y: hidden; /* Prevents main from scrolling, its children will control scroll */
            padding: 1rem 2rem 1rem 2rem; /* Adjusted padding for internal flow */
        }

        /* Container for the main table data - this is the element that scrolls */
        .data-table-container {
            flex-grow: 1;
            overflow-y: auto; /* Allow scrolling within the table area */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            background-color: white;
            padding-bottom: 0.5rem;
        }

        /* Center text in badge cells */
        .status-cell {
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="app-container">
        <!-- Header (Fixed Height) -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-700 flex items-center">
                    <i data-lucide="droplet" class="w-7 h-7 mr-2 text-indigo-500"></i>
                    ระบบบริหารจัดการน้ำ (เมืองทองธานี)
                </h1>
                <div class="flex items-center space-x-4">
                    <p id="current-time" class="text-sm text-gray-600 font-medium"></p>
                    <button id="refresh-button" class="p-2 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition flex items-center" title="โหลดข้อมูลใหม่">
                        <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content (Fills remaining height) -->
        <main class="main-content max-w-7xl mx-auto w-full flex flex-col space-y-4">

            <!-- 1. Combined Water Level Data Header (Fixed Height) -->
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 flex items-center">
                <i data-lucide="waves" class="w-5 h-5 mr-2 text-blue-600"></i>
                ระดับน้ำทั้งหมด (เมืองทองธานี และ เจ้าพระยา)
            </h2>
            
            <!-- 2. Pump Status Summary Bar (Combined & Fixed Height) -->
            <div class="bg-indigo-50 p-3 rounded-lg shadow-sm flex items-center justify-between text-sm font-semibold border border-indigo-200">
                <div class="flex items-center text-indigo-700">
                    <i data-lucide="gauge" class="w-4 h-4 mr-2"></i>
                    สรุปสถานะเครื่องสูบน้ำ (Sheet 3)
                </div>
                <div class="flex space-x-6">
                    <span class="flex items-center text-gray-700">
                        สถานีทั้งหมด: <span id="total-pump-stations" class="text-indigo-800 ml-1 text-base font-extrabold">0</span> <span class="ml-1 font-medium text-xs text-gray-500">สถานี</span>
                    </span>
                    <span class="flex items-center text-green-600">
                        สถานะปกติ: <span id="normal-pump-stations" class="text-green-800 ml-1 text-base font-extrabold">0</span> <span class="ml-1 font-medium text-xs text-gray-500">สถานี</span>
                    </span>
                </div>
            </div>

            <!-- 3. Scrollable Data Table Container (Takes remaining height) -->
            <div id="data-sheet-combined-water-level" class="data-table-container flex items-center justify-center text-gray-500">
                <!-- Combined Data will be rendered here -->
                <p class="text-center text-indigo-500 font-semibold flex items-center justify-center">
                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> 
                    กำลังโหลดข้อมูลระดับน้ำ...
                </p>
            </div>
            
        </main>
    </div>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIG & FIREBASE INIT (REQUIRED) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentication setup
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    // Start data fetch once auth is ready
                    fetchDashboardData();
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in.");
                    signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
                }
            });
            
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign-in failed:", e));
            }
        } else {
            console.error("Firebase config is missing. Data fetching will be mocked.");
            // Mock data fetch if Firebase is not configured
            setTimeout(fetchDashboardData, 1000); 
        }
        
        // Helper function for UI updates
        const updateTime = () => {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };
            document.getElementById('current-time').textContent = now.toLocaleDateString('th-TH', options);
        };
        setInterval(updateTime, 1000);
        updateTime();
        
        // Apply Lucide icons
        lucide.createIcons();

        // -------------------------------------------------------------
        // CONFIGURATION: REPLACE WITH YOUR GOOGLE SHEET CSV EXPORT URLS
        // NOTE: The URL MUST END with /export?format=csv
        // -------------------------------------------------------------
        const DATA_CONFIG = [
            // Example of a correct CSV URL: https://docs.google.com/spreadsheets/d/e/2PACX-1vRzTzL.../pub?gid=0&single=true&output=csv
            { url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT452CdpcF_hoA-_x3a6Ji0YKeWTuSr_9CM0We83aAAPiBWMRoHrKEujaYtEzHMZYMLEL8wKa10NPYF/pub?gid=675852265&single=true&output=csv', type: 'WATER_LEVEL_MTT' },
            { url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5OYSm3Hn1V4kegJf9x3iK2OGvUIL7vbnWryNUsx15VCm4NdxoVoWZMx1vWTlKcZskeD-YYjhbKn2V/pub?gid=202563025&single=true&output=csv', type: 'WATER_LEVEL_CPY' },
            { url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTyPcfGQReUPOHckF-6bA4UOucC8cbqRvHj-aTP7uWRkBjvQ4HrieGIhcet4OH9O0DjT_M2FM3QaaV9/pub?gid=273571070&single=true&output=csv', type: 'PUMP_STATUS' }
        ];
        
        // -------------------------------------------------------------
        // HELPER FUNCTIONS FOR FORMATTING UI
        // -------------------------------------------------------------

        /**
         * จัดรูปแบบการแสดงผลของคอลัมน์ "ส่วนต่างระดับน้ำ" พร้อมสีและไอคอนสามเหลี่ยม
         * @param {string | number} value - ค่าส่วนต่างระดับน้ำ (อาจเป็น String จาก CSV)
         * @returns {string} HTML string ที่มีสีและไอคอน
         */
        function formatDifference(value) {
            const unit = ' รทก.'; // หน่วยที่ใช้ร่วมกัน
            
            // 1. แปลงค่าเป็นตัวเลข
            const numValue = parseFloat(value);
            if (isNaN(numValue)) {
                return `<span class="text-gray-500">-</span>`;
            }

            let iconName = '';
            let colorClass = '';

            if (numValue > 0) {
                // เพิ่มขึ้น (แดง)
                iconName = 'triangle'; // Lucide icon for up arrow
                colorClass = 'text-red-600 font-semibold';
            } else if (numValue < 0) {
                // ลดลง (เขียว)
                iconName = 'triangle-down'; // Lucide icon for down arrow
                colorClass = 'text-green-600 font-semibold';
            } else {
                // คงที่ (เทา)
                return `<span class="text-gray-500">0.00 ${unit}</span>`;
            }

            const formattedValue = numValue.toFixed(2); // จัดรูปแบบเป็นทศนิยม 2 ตำแหน่ง
            
            return `
                <span class="${colorClass} flex items-center justify-start whitespace-nowrap">
                    <i data-lucide="${iconName}" class="w-4 h-4 mr-1 fill-current stroke-current"></i>
                    ${formattedValue} ${unit}
                </span>
            `;
        }

        /**
         * จัดรูปแบบการแสดงผลของคอลัมน์ "ระดับการแจ้งเตือน" ด้วย Badge สี
         * @param {string} status - สถานะการแจ้งเตือน ('ปกติ', 'เฝ้าระวัง', 'วิกฤติ')
         * @returns {string} HTML string สำหรับ Badge
         */
        function formatStatusBadge(status) {
            let colorClass, iconName;
            
            switch (status) {
                case 'ปกติ':
                    colorClass = 'bg-green-100 text-green-700 border-green-300';
                    iconName = 'check-circle';
                    break;
                case 'เฝ้าระวัง':
                    // ใช้สีเหลืองอ่อนและไอคอนตาสำหรับ 'เฝ้าระวัง'
                    colorClass = 'bg-yellow-100 text-yellow-700 border-yellow-300';
                    iconName = 'eye';
                    break;
                case 'วิกฤติ':
                    // ใช้สีแดงและไอคอนแจ้งเตือนสำหรับ 'วิกฤติ'
                    colorClass = 'bg-red-100 text-red-700 border-red-300';
                    iconName = 'alert-triangle';
                    break;
                default:
                    return `<span class="text-gray-500">-</span>`;
            }

            return `
                <div class="inline-flex items-center justify-center w-full px-2 py-1.5 ${colorClass} rounded-full border shadow-sm text-xs font-semibold">
                    <i data-lucide="${iconName}" class="w-3 h-3 mr-1"></i>
                    ${status}
                </div>
            `;
        }
        
        /**
         * จัดรูปแบบระดับน้ำพร้อมหน่วย
         * @param {string | number} value - ค่าระดับน้ำ
         * @param {string} unit - หน่วยที่จะแสดง
         * @param {boolean} fixedTwoDecimal - กำหนดว่าจะต้องแปลงเป็นทศนิยม 2 ตำแหน่งหรือไม่
         * @param {boolean} isChaophrayaDam - ตรวจสอบว่าเป็น เขื่อนเจ้าพระยา หรือไม่ เพื่อจัดการคอมม่า
         * @returns {string} ค่าพร้อมหน่วย
         */
        function formatLevelWithUnit(value, unit, fixedTwoDecimal = true, isChaophrayaDam = false) {
            let cleanValue = String(value);

            // *CRITICAL FIX* สำหรับ เขื่อนเจ้าพระยา: ลบคอมมาออกก่อนแปลงเป็นตัวเลข
            if (isChaophrayaDam) {
                // If the CSV gives "2,500", remove the comma so parseFloat recognizes it as 2500, not 2.00
                cleanValue = cleanValue.replace(/,/g, '');
            }
            
            const numValue = parseFloat(cleanValue);

            if (isNaN(numValue)) {
                return `- ${unit}`;
            }
            
            if (fixedTwoDecimal) {
                return `${numValue.toFixed(2)} ${unit}`;
            } else {
                // สำหรับค่าที่ไม่ต้องการการแปลงทศนิยม เช่น เขื่อนเจ้าพระยา
                // ใช้ toLocaleString เพื่อใส่คอมมาคืนถ้าตัวเลขนั้นมีค่าหลักพัน (เพื่อให้ดูดีขึ้น)
                return `${numValue.toLocaleString('th-TH')} ${unit}`; 
            }
        }


        // -------------------------------------------------------------
        // PROCESSOR FUNCTIONS
        // -------------------------------------------------------------

        const DEFAULT_UNIT_LEVEL = 'รทก./MSL.';
        const CHAOPHRAYA_UNIT_LEVEL = 'ลบ.ม./วิ'; // สำหรับ "เขื่อนเจ้าพระยา"

        /**
         * Sheet 1: กรองข้อมูลเฉพาะ Lakeside เมืองทองธานี และ สะพานข้ามคลองบางพูด มสธ.
         * @param {Array<Object>} rawData - ข้อมูลดิบจาก Sheet 1
         * @returns {Array<Object>} ข้อมูลที่ผ่านการกรองแล้ว พร้อมเพิ่มคอลัมน์ Source และหน่วยวัด
         */
        function processSheet1Data(rawData) {
            console.log("Processing Sheet 1: Muangthong locations...");
            const targetStations = ['Lakeside เมืองทองธานี', 'สะพานข้ามคลองบางพูด มสธ.'];

            const filteredData = rawData.filter(item => {
                // ใช้ includes() เพื่อให้มีความยืดหยุ่นในการจับคู่ชื่อสถานี
                return item['จุดวัด'] && targetStations.some(target => item['จุดวัด'].includes(target));
            });
            
            // Standardize/Add Source and map to the new column headers
            return filteredData.map(item => ({
                Source: 'เมืองทองธานี', 
                'จุดวัด': item['จุดวัด'] || '-',
                // ใช้ formatLevelWithUnit สำหรับ รทก./MSL. (Fixed to 2 decimals)
                'ระดับน้ำปัจจุบัน': formatLevelWithUnit(item['ระดับน้ำปัจจุบัน'], DEFAULT_UNIT_LEVEL, true, false),
                'ระดับน้ำครั้งก่อน': formatLevelWithUnit(item['ระดับน้ำครั้งก่อน'], DEFAULT_UNIT_LEVEL, true, false),
                'ส่วนต่างระดับน้ำ': formatDifference(item['ส่วนต่างระดับน้ำ']),
                'ระดับการแจ้งเตือน': formatStatusBadge(item['ระดับการแจ้งเตือน']),
            }));
        }

        /**
         * Sheet 2: กรองข้อมูลเฉพาะ 5 จุดวัดที่ระบุ
         * **แก้ไข:** นำลอจิกการกรองที่ใช้ `includes` ออก เพื่อใช้ข้อมูลทั้งหมดที่ดึงมา
         * **แก้ไข:** สำหรับ "เขื่อนเจ้าพระยา" จะไม่แปลงค่าเป็นทศนิยม และจัดการคอมมา
         * @param {Array<Object>} rawData - ข้อมูลดิบจาก Sheet 2
         * @returns {Array<Object>} ข้อมูลที่ผ่านการกรองแล้ว พร้อมเพิ่มคอลัมน์ Source และหน่วยวัด
         */
        function processSheet2Data(rawData) {
            console.log("Processing Sheet 2: Chaophraya locations (using all available data)...");
            
            return rawData.map(item => {
                const station = item['จุดวัด'] || '-';
                
                // กำหนดหน่วยวัดและรูปแบบการแสดงผล
                let unit = DEFAULT_UNIT_LEVEL;
                let fixedTwoDecimal = true;
                let isChaophraya = false;

                if (station === 'เขื่อนเจ้าพระยา') {
                    unit = CHAOPHRAYA_UNIT_LEVEL;
                    fixedTwoDecimal = false; // ไม่แปลงค่าเป็นทศนิยม 2 ตำแหน่ง
                    isChaophraya = true; // ตั้งค่าสถานะเพื่อจัดการคอมมาใน formatLevelWithUnit
                }
                
                return {
                    Source: 'แม่น้ำเจ้าพระยา', 
                    'จุดวัด': station,
                    // เพิ่มหน่วยวัดตามเงื่อนไข
                    'ระดับน้ำปัจจุบัน': formatLevelWithUnit(item['ระดับน้ำปัจจุบัน'], unit, fixedTwoDecimal, isChaophraya),
                    'ระดับน้ำครั้งก่อน': formatLevelWithUnit(item['ระดับน้ำครั้งก่อน'], unit, fixedTwoDecimal, isChaophraya),
                    'ส่วนต่างระดับน้ำ': formatDifference(item['ส่วนต่างระดับน้ำ']),
                    'ระดับการแจ้งเตือน': formatStatusBadge(item['ระดับการแจ้งเตือน']),
                };
            }).filter(item => item['จุดวัด'] !== '-'); // กรองรายการที่ไม่มีชื่อจุดวัดออก
        }

        /**
         * Sheet 3: สรุปจำนวนสถานีทั้งหมดและสถานะปกติ
         * @param {Array<Object>} rawData - ข้อมูลดิบจาก Sheet 3 
         * @returns {null} อัปเดตตัวเลขใน Card โดยตรง
         */
        function processSheet3Data(rawData) {
            console.log("Processing Sheet 3: Aggregating summary...");
            
            const totalStations = rawData.length;
            const totalEl = document.getElementById('total-pump-stations');
            if (totalEl) totalEl.textContent = totalStations.toLocaleString('th-TH');
            
            const STATUS_COLUMN_NAME = 'สถานะปั๊ม'; 
            const normalStations = rawData.filter(item => {
                return item[STATUS_COLUMN_NAME] === 'ปกติ';
            }).length;

            const normalEl = document.getElementById('normal-pump-stations');
            if (normalEl) normalEl.textContent = normalStations.toLocaleString('th-TH');

            console.log(`Summary: Total=${totalStations}, Normal=${normalStations}`);
            return null;
        }

        // -------------------------------------------------------------
        // LIVE DATA FETCH FUNCTION
        // -------------------------------------------------------------

        /**
         * ดึงข้อมูลจาก Google Sheet Public CSV URL โดยใช้ d3.csv
         */
        async function fetchGoogleSheetData(url) {
            console.log("Attempting to fetch data from:", url);
            
            if (url.includes('YOUR_SHEET_URL')) {
                throw new Error("กรุณาแทนที่ 'YOUR_SHEET_URL_X_HERE' ด้วย Public CSV Export URL จริง");
            }

            try {
                const data = await d3.csv(url);
                console.log(`Successfully fetched ${data.length} records from ${url}`);
                return data;
            } catch (error) {
                console.error("Error fetching or parsing CSV:", error);
                throw new Error(`ไม่สามารถโหลดข้อมูลจาก URL นี้ได้: ${url}`);
            }
        }

        /**
         * สร้าง HTML สำหรับตารางข้อมูล
         */
        function generateDataTableHtml(data, columns) {
            if (!data || data.length === 0) {
                return '<p class="p-6 text-center text-gray-500">ไม่มีข้อมูลที่ต้องแสดง (โปรดตรวจสอบ URL และชื่อคอลัมน์ใน CSV)</p>';
            }

            // 1. Header Row
            // Sticky header inside the scrollable container
            const headerHtml = `
                <thead class="bg-gray-100 sticky top-0 z-5">
                    <tr>
                        ${columns.map(col => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`).join('')}
                    </tr>
                </thead>
            `;

            // 2. Body Rows
            const bodyHtml = data.map(row => `
                <tr class="hover:bg-gray-50 transition duration-150">
                    ${columns.map(col => {
                        const cellValue = row[col] !== undefined ? row[col] : '-';
                        // สำหรับคอลัมน์ "ระดับการแจ้งเตือน" ให้ใช้ class status-cell เพื่อจัดกลาง
                        const cellClass = col === 'ระดับการแจ้งเตือน' ? 'status-cell' : 'text-left';
                        
                        return `<td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 ${cellClass}">${cellValue}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            return `
                <div class="overflow-x-auto w-full">
                    <table class="min-w-full divide-y divide-gray-200">
                        ${headerHtml}
                        <tbody class="bg-white divide-y divide-gray-200">${bodyHtml}</tbody>
                    </table>
                </div>
            `;
        }

        // -------------------------------------------------------------
        // MAIN FETCH AND RENDER LOGIC
        // -------------------------------------------------------------

        async function fetchDashboardData() {
            console.log("Starting dashboard data fetch (Combined)...");
            
            const combinedEl = document.getElementById('data-sheet-combined-water-level');
            combinedEl.innerHTML = `
                <p class="text-center text-indigo-500 font-semibold flex items-center justify-center p-6">
                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> 
                    กำลังโหลดข้อมูลระดับน้ำ...
                </p>`;
            lucide.createIcons(); // Ensure loading icon shows

            // 1. Fetch and Process Water Level Data (Sheet 1 & 2) concurrently
            let combinedData = [];
            const combinedColumns = ['Source', 'จุดวัด', 'ระดับน้ำปัจจุบัน', 'ระดับน้ำครั้งก่อน', 'ส่วนต่างระดับน้ำ', 'ระดับการแจ้งเตือน']; 

            try {
                // Fetch all data sources concurrently
                const results = await Promise.allSettled([
                    fetchGoogleSheetData(DATA_CONFIG[0].url),
                    fetchGoogleSheetData(DATA_CONFIG[1].url)
                ]);

                // Process Sheet 1 Data
                if (results[0].status === 'fulfilled') {
                    combinedData = combinedData.concat(processSheet1Data(results[0].value));
                } else {
                    console.error("Failed to load Sheet 1 data:", results[0].reason);
                }

                // Process Sheet 2 Data (ดึงมาทั้งหมดตามข้อมูลที่ CSV ส่งมา)
                if (results[1].status === 'fulfilled') {
                    if (results[1].value.length === 0) {
                         console.warn("Sheet 2 data loaded successfully but contained 0 records after CSV parsing. Check if the sheet is empty or the CSV export is correct.");
                    }
                    combinedData = combinedData.concat(processSheet2Data(results[1].value));
                } else {
                    console.error("Failed to load Sheet 2 data:", results[1].reason);
                }
                
                // Render Combined Data
                if (combinedData.length > 0) {
                    combinedEl.innerHTML = generateDataTableHtml(combinedData, combinedColumns);
                } else {
                    combinedEl.innerHTML = `<p class="p-6 text-center text-red-500 font-semibold">ไม่พบข้อมูลที่ต้องแสดง (Sheet 1 และ Sheet 2 ไม่สามารถโหลดข้อมูลได้ หรือไม่มีข้อมูลที่ผ่านการกรองแล้ว)</p>`;
                }

            } catch (error) {
                console.error("Error during overall water level data processing:", error);
                combinedEl.innerHTML = `<p class="p-6 text-center text-red-500 font-semibold">เกิดข้อผิดพลาดในการโหลดข้อมูลระดับน้ำ</p>`;
            }
            
            // 2. Fetch and Process Pump Status Data (Sheet 3)
            try {
                // แสดงสถานะโหลดก่อน
                const totalEl = document.getElementById('total-pump-stations');
                const normalEl = document.getElementById('normal-pump-stations');
                if (totalEl) { totalEl.textContent = '...'; totalEl.classList.add('animate-pulse'); }
                if (normalEl) { normalEl.textContent = '...'; normalEl.classList.add('animate-pulse'); }
                
                const rawData3 = await fetchGoogleSheetData(DATA_CONFIG[2].url);
                processSheet3Data(rawData3); // Updates status bar directly
                
                if (totalEl) totalEl.classList.remove('animate-pulse');
                if (normalEl) normalEl.classList.remove('animate-pulse');
            } catch (error) {
                console.error("Error fetching pump status data:", error);
                // แสดง Err หากดึงข้อมูลไม่ได้
                const totalEl = document.getElementById('total-pump-stations');
                const normalEl = document.getElementById('normal-pump-stations');
                if (totalEl) { totalEl.textContent = 'Err'; totalEl.classList.remove('animate-pulse'); }
                if (normalEl) { normalEl.textContent = 'Err'; normalEl.classList.remove('animate-pulse'); }
            }

            // Re-apply icons after content update
            lucide.createIcons();
        }

        document.getElementById('refresh-button').addEventListener('click', fetchDashboardData);
        
        // Initial call if not using Firebase (or after Firebase auth setup)
        if (!firebaseConfig || isAuthReady) {
             fetchDashboardData();
        }

    </script>
</body>
</html>
